{% extends 'base.html' %}
{% load static %}

{% block title %}Commandes Fournisseurs{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="page-header">
        <h1>üì¶ Gestion des Commandes Fournisseurs</h1>
        <p>Sc√©nario 8.1.1 - R√©approvisionnement intelligent avec alertes</p>
    </div>

    <!-- KPIs -->
    <div class="row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem;">
        <div class="kpi-card">
            <div class="kpi-icon blue">üìä</div>
            <div class="kpi-content">
                <h3>{{ total_commandes }}</h3>
                <p>Total Commandes</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon orange">‚è≥</div>
            <div class="kpi-content">
                <h3>{{ en_attente }}</h3>
                <p>En Attente</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon green">‚úÖ</div>
            <div class="kpi-content">
                <h3>{{ validees }}</h3>
                <p>Valid√©es</p>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon purple">üì¶</div>
            <div class="kpi-content">
                <h3>{{ livrees }}</h3>
                <p>Livr√©es</p>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem;">
            <a href="{% url 'creer_commande_fournisseur' %}" class="btn btn-primary">
                ‚ûï Nouvelle Commande
            </a>
            <a href="{% url 'dashboard_stock' %}" class="btn btn-secondary">
                ‚Üê Retour au Stock
            </a>
        </div>
        
        <!-- Filtres -->
        <form method="GET" style="display: flex; gap: 1rem;">
            <select name="statut" class="form-control" style="width: 200px;" onchange="this.form.submit()">
                <option value="">Tous les statuts</option>
                <option value="EN_ATTENTE" {% if statut_filtre == 'EN_ATTENTE' %}selected{% endif %}>En Attente</option>
                <option value="VALIDEE" {% if statut_filtre == 'VALIDEE' %}selected{% endif %}>Valid√©e</option>
                <option value="LIVREE" {% if statut_filtre == 'LIVREE' %}selected{% endif %}>Livr√©e</option>
                <option value="ANNULEE" {% if statut_filtre == 'ANNULEE' %}selected{% endif %}>Annul√©e</option>
            </select>
            
            <select name="fournisseur" class="form-control" style="width: 200px;" onchange="this.form.submit()">
                <option value="">Tous les fournisseurs</option>
                {% for f in fournisseurs %}
                <option value="{{ f.id }}" {% if fournisseur_filtre == f.id|stringformat:"s" %}selected{% endif %}>
                    {{ f.nom }}
                </option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Tableau des commandes -->
    <div class="card">
        <div class="card-header">
            <h3>üìã Liste des Commandes</h3>
        </div>
        <div class="card-body">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>FOURNISSEUR</th>
                        <th>DATE COMMANDE</th>
                        <th>LIVRAISON PR√âVUE</th>
                        <th>D√âLAI</th>
                        <th>STATUT</th>
                        <th>MONTANT TOTAL</th>
                        <th>CR√â√âE PAR</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cmd in commandes %}
                    <tr>
                        <td><strong>#{{ cmd.id }}</strong></td>
                        <td>{{ cmd.fournisseur.nom }}</td>
                        <td>{{ cmd.date_commande|date:"d/m/Y H:i" }}</td>
                        <td>{{ cmd.date_livraison_prevue|date:"d/m/Y" }}</td>
                        <td>
                            {% if cmd.date_livraison_reelle %}
                                {{ cmd.date_livraison_reelle|date:"d/m/Y" }}
                                {% if cmd.date_livraison_reelle <= cmd.date_livraison_prevue %}
                                    <span class="badge bg-success">√Ä temps</span>
                                {% else %}
                                    <span class="badge bg-danger">Retard</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if cmd.statut == 'EN_ATTENTE' %}
                                <span class="badge bg-warning">‚è≥ En Attente</span>
                            {% elif cmd.statut == 'VALIDEE' %}
                                <span class="badge bg-info">‚úÖ Valid√©e</span>
                            {% elif cmd.statut == 'LIVREE' %}
                                <span class="badge bg-success">üì¶ Livr√©e</span>
                            {% elif cmd.statut == 'ANNULEE' %}
                                <span class="badge bg-danger">‚ùå Annul√©e</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ cmd.montant_total|floatformat:0 }} FCFA</strong></td>
                        <td>{% if cmd.employe %}{{ cmd.employe.get_full_name }}{% else %}N/A{% endif %}</td>
                        <td>
                            {% if cmd.statut == 'EN_ATTENTE' %}
                                <a href="{% url 'valider_commande_fournisseur' cmd.id %}" 
                                   class="btn btn-sm btn-success"
                                   onclick="return confirm('Valider cette commande et l\'envoyer au fournisseur?')">
                                    ‚úÖ Valider
                                </a>
                            {% elif cmd.statut == 'VALIDEE' %}
                                <a href="{% url 'recevoir_commande_fournisseur' cmd.id %}" 
                                   class="btn btn-sm btn-primary"
                                   onclick="return confirm('Marquer cette commande comme re√ßue? Les stocks seront mis √† jour automatiquement.')">
                                    üì¶ Recevoir
                                </a>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    <!-- D√©tails des produits de la commande -->
                    {% if cmd.lignes.all %}
                    <tr style="background-color: #F9FAFB;">
                        <td colspan="9" style="padding: 0;">
                            <div style="padding: 1rem 2rem;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid #E5E7EB;">
                                            <th style="padding: 0.5rem; text-align: left; font-weight: 600; color: #374151;">Produit</th>
                                            <th style="padding: 0.5rem; text-align: center; font-weight: 600; color: #374151;">Stock Actuel</th>
                                            <th style="padding: 0.5rem; text-align: center; font-weight: 600; color: #374151;">Quantit√© Command√©e</th>
                                            <th style="padding: 0.5rem; text-align: right; font-weight: 600; color: #374151;">Prix Unitaire</th>
                                            <th style="padding: 0.5rem; text-align: right; font-weight: 600; color: #374151;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for ligne in cmd.lignes.all %}
                                        <tr style="border-bottom: 1px solid #E5E7EB;">
                                            <td style="padding: 0.5rem;">{{ ligne.produit.nom }}</td>
                                            <td style="padding: 0.5rem; text-align: center;">
                                                <span class="badge {% if ligne.produit.stock_actuel <= ligne.produit.stock_critique %}bg-danger{% else %}bg-success{% endif %}">
                                                    {{ ligne.produit.stock_actuel }}
                                                </span>
                                            </td>
                                            <td style="padding: 0.5rem; text-align: center;"><strong>{{ ligne.quantite_commandee }}</strong></td>
                                            <td style="padding: 0.5rem; text-align: right;">{{ ligne.prix_unitaire|floatformat:0 }} FCFA</td>
                                            <td style="padding: 0.5rem; text-align: right;"><strong>{{ ligne.montant_ligne|floatformat:0 }} FCFA</strong></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">
                            Aucune commande trouv√©e.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.kpi-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
}

.kpi-icon {
    font-size: 2.5rem;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.kpi-icon.blue { background: #E3F2FD; }
.kpi-icon.orange { background: #FFF3E0; }
.kpi-icon.green { background: #E8F5E9; }
.kpi-icon.purple { background: #F3E5F5; }

.kpi-content h3 {
    margin: 0;
    font-size: 2rem;
    font-weight: bold;
    color: #2563EB;
}

.kpi-content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
}

.card-header {
    background: linear-gradient(135deg, #2563EB 0%, #1e40af 100%);
    color: white;
    padding: 1.5rem;
}

.card-header h3 {
    margin: 0;
    font-size: 1.25rem;
}

.card-body {
    padding: 0;
}

.table {
    margin: 0;
    width: 100%;
}

.table thead {
    background: #F8FAFC;
    position: sticky;
    top: 0;
}

.table th {
    padding: 1rem;
    font-weight: 600;
    color: #475569;
    border-bottom: 2px solid #E2E8F0;
    font-size: 0.85rem;
    text-transform: uppercase;
}

.table td {
    padding: 1rem;
    border-bottom: 1px solid #E2E8F0;
    vertical-align: middle;
}

.table tbody tr:hover {
    background: #F8FAFC;
}

.btn {
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    text-decoration: none;
    display: inline-block;
    font-weight: 500;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: linear-gradient(135deg, #2563EB 0%, #1e40af 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
}

.btn-secondary {
    background: #64748B;
    color: white;
}

.btn-sm {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

.btn-success {
    background: #28A745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.badge {
    padding: 0.4rem 0.8rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
}

.bg-warning { background: #FFC107; color: #000; }
.bg-info { background: #17A2B8; color: white; }
.bg-success { background: #28A745; color: white; }
.bg-danger { background: #DC3545; color: white; }

.form-control {
    padding: 0.6rem;
    border: 1px solid #E2E8F0;
    border-radius: 8px;
    font-size: 0.95rem;
}

.form-control:focus {
    outline: none;
    border-color: #2563EB;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}
</style>
{% endblock %}
